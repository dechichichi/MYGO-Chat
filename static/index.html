<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGO!!!!! Chat - è¿·å­ã§ã‚‚ã„ã„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            font-family: 'Noto Sans SC', sans-serif;
        }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #ec4899;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .message-enter {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-white">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="bg-black/30 backdrop-blur-sm border-b border-white/10">
            <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ¸</span>
                    <div>
                        <h1 class="font-bold text-lg">MyGO!!!!! Chat</h1>
                        <p class="text-xs text-white/50">è¿·å­ã§ã‚‚ã„ã„ã€è¿·å­ã§ã‚‚é€²ã‚</p>
                    </div>
                </div>
                <div class="flex bg-white/10 rounded-lg p-1">
                    <button onclick="switchMode('chat')" id="btn-chat" class="px-4 py-2 rounded-md text-sm font-medium transition-colors bg-pink-500 text-white">
                        ğŸ’¬ èŠå¤©
                    </button>
                    <button onclick="switchMode('agent')" id="btn-agent" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-white/70 hover:text-white">
                        ğŸ¤– Agent
                    </button>
                    <button onclick="switchMode('debate')" id="btn-debate" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-white/70 hover:text-white">
                        ğŸ¤ è®¨è®º
                    </button>
                </div>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="flex-1 max-w-4xl w-full mx-auto">
            <div class="h-[calc(100vh-72px)] bg-black/20 backdrop-blur-sm border-x border-white/10">
                <!-- èŠå¤©è§†å›¾ -->
                <div id="chat-view" class="flex flex-col h-full">
                    <!-- è§’è‰²é€‰æ‹© -->
                    <div class="p-4 border-b border-white/10 bg-black/20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <span id="current-avatar" class="text-3xl">ğŸ¤</span>
                                <div>
                                    <h2 id="current-name" class="font-bold text-lg">é«˜æ¾ç¯</h2>
                                    <p id="current-name-jp" class="text-sm text-white/60">Takamatsu Tomori</p>
                                </div>
                            </div>
                            <button onclick="clearChat()" class="px-3 py-1.5 text-sm bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
                                æ¸…ç©ºå¯¹è¯
                            </button>
                        </div>
                        <div id="char-select" class="flex gap-2 flex-wrap"></div>
                    </div>

                    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
                    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div id="empty-state" class="h-full flex flex-col items-center justify-center text-center">
                            <span class="text-6xl mb-4">ğŸ¤</span>
                            <h3 class="text-xl font-bold mb-2">å’Œ é«˜æ¾ç¯ èŠå¤©</h3>
                            <p class="text-white/60 max-w-md">æ„Ÿæ€§ç»†è…»çš„"ç¾½ä¸˜æ€ªå¥³ç”Ÿ"ï¼Œç”¨è¯—æ„çš„è¯­è¨€è¡¨è¾¾å†…å¿ƒ</p>
                            <p class="text-white/40 text-sm mt-4">å‘é€æ¶ˆæ¯å¼€å§‹å¯¹è¯å§</p>
                        </div>
                    </div>

                    <!-- è¾“å…¥æ¡† -->
                    <div class="p-4 border-t border-white/10 bg-black/20">
                        <div class="flex gap-3">
                            <input type="text" id="chat-input" placeholder="å¯¹ é«˜æ¾ç¯ è¯´ç‚¹ä»€ä¹ˆ..."
                                class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-pink-500 transition-colors"
                                onkeypress="if(event.key==='Enter')sendMessage()">
                            <button onclick="sendMessage()" id="send-btn"
                                class="px-6 py-3 bg-gradient-to-r from-pink-500 to-rose-500 rounded-xl font-medium hover:opacity-90 transition-opacity disabled:opacity-50">
                                å‘é€
                            </button>
                        </div>
                    </div>
                </div>

                <!-- è®¨è®ºè§†å›¾ -->
                <div id="debate-view" class="flex flex-col h-full hidden">
                    <!-- é…ç½®é¢æ¿ -->
                    <div id="debate-config" class="p-6 space-y-6 overflow-y-auto">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">ğŸ¸ ä¹é˜Ÿè®¨è®ºä¼š</h2>
                            <p class="text-white/60">é€‰æ‹©è¯é¢˜å’Œå‚ä¸æˆå‘˜ï¼Œå¼€å§‹ä¸€åœºè®¨è®º</p>
                        </div>

                        <!-- é¢„è®¾è¯é¢˜ -->
                        <div>
                            <label class="block text-sm font-medium mb-2">é¢„è®¾è¯é¢˜</label>
                            <div id="preset-topics" class="flex gap-2 flex-wrap"></div>
                        </div>

                        <!-- è¯é¢˜è¾“å…¥ -->
                        <div>
                            <label class="block text-sm font-medium mb-2">è®¨è®ºè¯é¢˜</label>
                            <input type="text" id="debate-topic" value="ä¹é˜Ÿå¯¹æˆ‘ä»¬æ¥è¯´æ„å‘³ç€ä»€ä¹ˆï¼Ÿ"
                                class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-pink-500">
                        </div>

                        <!-- ç«‹åœºè®¾ç½® -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-emerald-400">æ­£æ–¹ç«‹åœº</label>
                                <textarea id="pro-stance" rows="2"
                                    class="w-full bg-emerald-500/10 border border-emerald-500/30 rounded-xl px-4 py-3 focus:outline-none focus:border-emerald-500 resize-none">ä¹é˜Ÿæ˜¯æˆ‘ä»¬è¡¨è¾¾è‡ªæˆ‘ã€å¯»æ‰¾å½’å±çš„åœ°æ–¹</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-rose-400">åæ–¹ç«‹åœº</label>
                                <textarea id="con-stance" rows="2"
                                    class="w-full bg-rose-500/10 border border-rose-500/30 rounded-xl px-4 py-3 focus:outline-none focus:border-rose-500 resize-none">ä¹é˜Ÿè®©æˆ‘ä»¬å­¦ä¼šäº†é¢å¯¹å›°éš¾å’Œæˆé•¿</textarea>
                            </div>
                        </div>

                        <!-- é˜Ÿä¼é€‰æ‹© -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-emerald-400">æ­£æ–¹æˆå‘˜</label>
                                <div id="pro-team" class="space-y-2"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-rose-400">åæ–¹æˆå‘˜</label>
                                <div id="con-team" class="space-y-2"></div>
                            </div>
                        </div>

                        <!-- å¼€å§‹æŒ‰é’® -->
                        <button onclick="startDebate()" id="start-debate-btn"
                            class="w-full py-4 bg-gradient-to-r from-pink-500 to-rose-500 rounded-xl font-bold text-lg hover:opacity-90 disabled:opacity-50 transition-all">
                            å¼€å§‹è®¨è®º
                        </button>
                    </div>

                    <!-- è®¨è®ºç»“æœ -->
                    <div id="debate-result" class="flex flex-col h-full hidden">
                        <div class="p-4 border-b border-white/10 bg-black/20">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 id="debate-title" class="font-bold"></h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span id="debate-status" class="px-2 py-0.5 rounded text-xs bg-amber-500">è¿›è¡Œä¸­</span>
                                        <span id="debate-phase" class="text-sm text-white/60"></span>
                                    </div>
                                </div>
                                <button onclick="resetDebate()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
                                    æ–°è®¨è®º
                                </button>
                            </div>
                        </div>
                        <div id="debate-records" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
                    </div>
                </div>

                <!-- Agent è§†å›¾ -->
                <div id="agent-view" class="flex flex-col h-full hidden">
                    <!-- Agent æ¨¡å¼é€‰æ‹© -->
                    <div class="p-4 border-b border-white/10 bg-black/20">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h2 class="text-xl font-bold">ğŸ¤– Agent æ¨¡å¼</h2>
                                <p class="text-sm text-white/60">ä½“éªŒå®Œæ•´çš„Agentèƒ½åŠ›ï¼šå·¥å…·è°ƒç”¨ã€åæ€æœºåˆ¶</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="switchAgentMode('chat')" id="btn-agent-chat" class="px-3 py-1.5 rounded-lg text-sm transition-colors bg-purple-500">
                                    AgentèŠå¤©
                                </button>
                                <button onclick="switchAgentMode('discussion')" id="btn-agent-discussion" class="px-3 py-1.5 rounded-lg text-sm transition-colors bg-white/10 hover:bg-white/20">
                                    ä¸»æŒäººè®¨è®º
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Agent èŠå¤©æ¨¡å¼ -->
                    <div id="agent-chat-view" class="flex flex-col flex-1">
                        <!-- è§’è‰²å’Œé€‰é¡¹ -->
                        <div class="p-4 border-b border-white/10 bg-black/10">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span id="agent-avatar" class="text-3xl">ğŸ¤</span>
                                    <div>
                                        <h3 id="agent-name" class="font-bold">é«˜æ¾ç¯</h3>
                                        <p class="text-xs text-white/60">Agentæ¨¡å¼ - å¸¦å·¥å…·å’Œåæ€</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="enable-tools" checked class="w-4 h-4 accent-purple-500">
                                        <span class="text-sm">å·¥å…·è°ƒç”¨</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="enable-reflection" checked class="w-4 h-4 accent-purple-500">
                                        <span class="text-sm">åæ€æœºåˆ¶</span>
                                    </label>
                                </div>
                            </div>
                            <div id="agent-char-select" class="flex gap-2 flex-wrap mt-3"></div>
                        </div>

                        <!-- Agent æ¶ˆæ¯åˆ—è¡¨ -->
                        <div id="agent-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                            <div id="agent-empty-state" class="h-full flex flex-col items-center justify-center text-center">
                                <span class="text-6xl mb-4">ğŸ¤–</span>
                                <h3 class="text-xl font-bold mb-2">Agent æ¨¡å¼</h3>
                                <p class="text-white/60 max-w-md">ä½“éªŒå¸¦æœ‰å·¥å…·è°ƒç”¨å’Œåæ€æœºåˆ¶çš„å¯¹è¯</p>
                                <div class="mt-4 text-left text-sm text-white/50 max-w-md space-y-2">
                                    <p>ğŸ”§ <b>å·¥å…·è°ƒç”¨</b>: è®°å¿†å›å¿†ã€æ­Œè¯æœç´¢ã€æ°›å›´æ„ŸçŸ¥</p>
                                    <p>ğŸª <b>åæ€æœºåˆ¶</b>: è‡ªåŠ¨è¯„ä¼°å›å¤è´¨é‡å¹¶ä¼˜åŒ–</p>
                                </div>
                            </div>
                        </div>

                        <!-- Agent è¾“å…¥æ¡† -->
                        <div class="p-4 border-t border-white/10 bg-black/20">
                            <div class="flex gap-3">
                                <input type="text" id="agent-input" placeholder="å’Œ Agent èŠèŠ..."
                                    class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-purple-500 transition-colors"
                                    onkeypress="if(event.key==='Enter')sendAgentMessage()">
                                <button onclick="sendAgentMessage()" id="agent-send-btn"
                                    class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-xl font-medium hover:opacity-90 transition-opacity disabled:opacity-50">
                                    å‘é€
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸»æŒäººè®¨è®ºæ¨¡å¼ -->
                    <div id="agent-discussion-view" class="flex flex-col flex-1 hidden">
                        <!-- é…ç½® -->
                        <div id="agent-discussion-config" class="p-6 space-y-6 overflow-y-auto">
                            <div>
                                <h3 class="text-xl font-bold mb-2">ğŸ­ ä¸»æŒäººAgenté©±åŠ¨è®¨è®º</h3>
                                <p class="text-white/60">ä¸»æŒäººAgentè‡ªä¸»å†³å®šå‘è¨€é¡ºåºå’Œå†…å®¹</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">è®¨è®ºè¯é¢˜</label>
                                <input type="text" id="agent-discussion-topic" value="éŸ³ä¹å¯¹æˆ‘ä»¬æ„å‘³ç€ä»€ä¹ˆ"
                                    class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-purple-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">å‚ä¸æˆå‘˜</label>
                                <div id="agent-participants" class="flex gap-2 flex-wrap"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">æœ€å¤§è½®æ•°</label>
                                <input type="number" id="agent-max-rounds" value="4" min="2" max="10"
                                    class="w-32 bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-purple-500">
                            </div>

                            <button onclick="startAgentDiscussion()" id="start-agent-discussion-btn"
                                class="w-full py-4 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-xl font-bold text-lg hover:opacity-90 disabled:opacity-50 transition-all">
                                å¼€å§‹ä¸»æŒäººè®¨è®º
                            </button>
                        </div>

                        <!-- è®¨è®ºç»“æœ -->
                        <div id="agent-discussion-result" class="flex flex-col h-full hidden">
                            <div class="p-4 border-b border-white/10 bg-black/20">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 id="agent-discussion-title" class="font-bold"></h3>
                                        <p class="text-sm text-white/60">ä¸»æŒäººAgentè‡ªä¸»é©±åŠ¨</p>
                                    </div>
                                    <button onclick="resetAgentDiscussion()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
                                        æ–°è®¨è®º
                                    </button>
                                </div>
                            </div>
                            <!-- å†³ç­–è®°å½• -->
                            <div id="agent-decisions" class="p-3 border-b border-white/10 bg-purple-500/10 text-sm overflow-x-auto">
                                <span class="text-white/60">ä¸»æŒäººå†³ç­–: </span>
                                <span id="agent-decisions-list"></span>
                            </div>
                            <div id="agent-discussion-records" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // è§’è‰²æ•°æ®
        const PHILOSOPHERS = [
            { type: 'tomori', name: 'é«˜æ¾ç¯', nameJp: 'Takamatsu Tomori', role: 'ä¸»å”±', avatar: 'ğŸ¤', description: 'æ„Ÿæ€§ç»†è…»çš„"ç¾½ä¸˜æ€ªå¥³ç”Ÿ"ï¼Œç”¨è¯—æ„çš„è¯­è¨€è¡¨è¾¾å†…å¿ƒ' },
            { type: 'anon', name: 'åƒæ—©çˆ±éŸ³', nameJp: 'Chihaya Anon', role: 'å‰ä»–', avatar: 'ğŸ¸', description: 'å…ƒæ°”æ»¡æ»¡çš„ä¼˜ç­‰ç”Ÿï¼Œæƒ³è¦é—ªé—ªå‘å…‰' },
            { type: 'rana', name: 'è¦ä¹å¥ˆ', nameJp: 'Kaname Rana', role: 'é¼“æ‰‹', avatar: 'ğŸ¥', description: 'ç¥å‡ºé¬¼æ²¡çš„å¤æ€ªå°‘å¥³ï¼Œè§‰å¾—ä¸€åˆ‡éƒ½å¾ˆæœ‰è¶£' },
            { type: 'soyo', name: 'é•¿å´ç´ ä¸–', nameJp: 'Nagasaki Soyo', role: 'è´æ–¯', avatar: 'ğŸ»', description: 'æ¸©æŸ”çš„å¤§å§å§ï¼Œå†…å¿ƒæ¸´æœ›çœŸæ­£çš„è¿æ¥' },
            { type: 'taki', name: 'æ¤åç«‹å¸Œ', nameJp: 'Shiina Taki', role: 'å‰ä»–', avatar: 'ğŸµ', description: 'å‚²å¨‡çš„ç‹¬ç‹¼ï¼Œå˜´ç¡¬å¿ƒè½¯çš„ä¹é˜Ÿå®é™…é¢†å¯¼è€…' },
        ];

        const PRESET_TOPICS = [
            { topic: 'ä¹é˜Ÿå¯¹æˆ‘ä»¬æ¥è¯´æ„å‘³ç€ä»€ä¹ˆï¼Ÿ', proStance: 'ä¹é˜Ÿæ˜¯æˆ‘ä»¬è¡¨è¾¾è‡ªæˆ‘ã€å¯»æ‰¾å½’å±çš„åœ°æ–¹', conStance: 'ä¹é˜Ÿè®©æˆ‘ä»¬å­¦ä¼šäº†é¢å¯¹å›°éš¾å’Œæˆé•¿' },
            { topic: 'è¿·èŒ«çš„æ—¶å€™åº”è¯¥æ€ä¹ˆåŠï¼Ÿ', proStance: 'è¿·èŒ«æ—¶åº”è¯¥åœä¸‹æ¥å€¾å¬å†…å¿ƒçš„å£°éŸ³', conStance: 'è¿·èŒ«æ—¶åº”è¯¥ç»§ç»­å‰è¿›ï¼Œåœ¨è¡ŒåŠ¨ä¸­æ‰¾åˆ°æ–¹å‘' },
            { topic: 'å‹æƒ…å’Œæ¢¦æƒ³å“ªä¸ªæ›´é‡è¦ï¼Ÿ', proStance: 'å‹æƒ…æ˜¯æ”¯æ’‘æˆ‘ä»¬è¿½é€æ¢¦æƒ³çš„åŠ›é‡', conStance: 'æ¢¦æƒ³æ˜¯è®©å‹æƒ…æ›´æœ‰æ„ä¹‰çš„ç›®æ ‡' },
        ];

        // çŠ¶æ€
        let currentMode = 'chat';
        let currentChar = 'tomori';
        let sessionId = 'session_' + Date.now();
        let messages = [];
        let isLoading = false;
        let proTeam = ['tomori', 'anon'];
        let conTeam = ['taki', 'soyo'];
        let debateId = null;
        let pollTimer = null;

        // åˆå§‹åŒ–
        function init() {
            renderCharSelect();
            renderPresetTopics();
            renderTeamSelect();
        }

        // åˆ‡æ¢æ¨¡å¼
        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('chat-view').classList.toggle('hidden', mode !== 'chat');
            document.getElementById('debate-view').classList.toggle('hidden', mode !== 'debate');
            document.getElementById('agent-view').classList.toggle('hidden', mode !== 'agent');
            
            ['chat', 'debate', 'agent'].forEach(m => {
                const btn = document.getElementById(`btn-${m}`);
                btn.classList.toggle('bg-pink-500', mode === m);
                btn.classList.toggle('text-white/70', mode !== m);
            });
            
            if (mode === 'agent') {
                renderAgentCharSelect();
                renderAgentParticipants();
            }
        }

        // æ¸²æŸ“è§’è‰²é€‰æ‹©
        function renderCharSelect() {
            const container = document.getElementById('char-select');
            container.innerHTML = PHILOSOPHERS.map(p => `
                <button onclick="selectChar('${p.type}')" 
                    class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${currentChar === p.type ? 'bg-pink-500' : 'bg-white/10 hover:bg-white/20'}">
                    <span>${p.avatar}</span>
                    <span>${p.name}</span>
                </button>
            `).join('');
        }

        // é€‰æ‹©è§’è‰²
        function selectChar(type) {
            currentChar = type;
            const char = PHILOSOPHERS.find(p => p.type === type);
            document.getElementById('current-avatar').textContent = char.avatar;
            document.getElementById('current-name').textContent = char.name;
            document.getElementById('current-name-jp').textContent = char.nameJp;
            document.getElementById('chat-input').placeholder = `å¯¹ ${char.name} è¯´ç‚¹ä»€ä¹ˆ...`;
            
            // æ›´æ–°ç©ºçŠ¶æ€
            const emptyState = document.getElementById('empty-state');
            if (emptyState) {
                emptyState.innerHTML = `
                    <span class="text-6xl mb-4">${char.avatar}</span>
                    <h3 class="text-xl font-bold mb-2">å’Œ ${char.name} èŠå¤©</h3>
                    <p class="text-white/60 max-w-md">${char.description}</p>
                    <p class="text-white/40 text-sm mt-4">å‘é€æ¶ˆæ¯å¼€å§‹å¯¹è¯å§</p>
                `;
            }
            
            clearChat();
            renderCharSelect();
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            if (!content || isLoading) return;

            input.value = '';
            isLoading = true;
            document.getElementById('send-btn').disabled = true;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', content);

            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showTypingIndicator();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: content,
                        philosopher: currentChar,
                    }),
                });

                if (!response.ok) throw new Error('è¯·æ±‚å¤±è´¥');

                const data = await response.json();
                hideTypingIndicator();
                addMessage('assistant', data.response, data.philosopher, data.emotion_level, data.critical_hit);
            } catch (error) {
                console.error('Chat error:', error);
                hideTypingIndicator();
                addMessage('assistant', 'æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶å‡ºäº†ç‚¹é—®é¢˜...è¿·å­ã§ã‚‚ã„ã„ï¼Œä½†ç°åœ¨çœŸçš„è¿ä¸ä¸Šäº†ã€‚');
            } finally {
                isLoading = false;
                document.getElementById('send-btn').disabled = false;
            }
        }

        // æ·»åŠ æ¶ˆæ¯
        function addMessage(role, content, philosopher = '', emotionLevel = '', criticalHit = false) {
            const container = document.getElementById('messages');
            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.remove();

            const char = PHILOSOPHERS.find(p => p.type === currentChar);
            const isUser = role === 'user';

            const msgDiv = document.createElement('div');
            msgDiv.className = `message-enter flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            let emotionBadge = '';
            if (emotionLevel && emotionLevel !== 'neutral') {
                const emotionLabels = { pain: 'ğŸ˜¢ ç—›è‹¦', confusion: 'ğŸ˜µ è¿·èŒ«', complaint: 'ğŸ˜¤ æŠ±æ€¨', excuse: 'ğŸ˜ æ‰¾å€Ÿå£' };
                emotionBadge = `<span class="text-xs px-2 py-0.5 rounded bg-white/10 text-white/60">${emotionLabels[emotionLevel] || emotionLevel}</span>`;
            }
            
            let criticalBadge = criticalHit ? '<span class="text-xs px-2 py-0.5 rounded bg-red-500/30 text-red-300">ğŸ’¥ Critical Hit!</span>' : '';

            msgDiv.innerHTML = `
                <div class="max-w-[80%] ${isUser ? 'bg-pink-500/20 border-pink-500/30' : 'bg-white/10 border-white/20'} border rounded-2xl px-4 py-3">
                    ${!isUser ? `<div class="flex items-center gap-2 mb-2">
                        <span>${char.avatar}</span>
                        <span class="font-medium text-sm">${char.name}</span>
                        ${emotionBadge}
                        ${criticalBadge}
                    </div>` : ''}
                    <p class="whitespace-pre-wrap leading-relaxed">${content}</p>
                </div>
            `;

            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const container = document.getElementById('messages');
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'flex items-center gap-2 text-white/60';
            indicator.innerHTML = `
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
                <span>æ­£åœ¨æ€è€ƒ...</span>
            `;
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            messages = [];
            sessionId = 'session_' + Date.now();
            const container = document.getElementById('messages');
            const char = PHILOSOPHERS.find(p => p.type === currentChar);
            container.innerHTML = `
                <div id="empty-state" class="h-full flex flex-col items-center justify-center text-center">
                    <span class="text-6xl mb-4">${char.avatar}</span>
                    <h3 class="text-xl font-bold mb-2">å’Œ ${char.name} èŠå¤©</h3>
                    <p class="text-white/60 max-w-md">${char.description}</p>
                    <p class="text-white/40 text-sm mt-4">å‘é€æ¶ˆæ¯å¼€å§‹å¯¹è¯å§</p>
                </div>
            `;
        }

        // ==================== è®¨è®ºæ¨¡å¼ ====================

        // æ¸²æŸ“é¢„è®¾è¯é¢˜
        function renderPresetTopics() {
            const container = document.getElementById('preset-topics');
            container.innerHTML = PRESET_TOPICS.map((p, i) => `
                <button onclick="selectPreset(${i})" class="px-3 py-1.5 rounded-lg text-sm transition-colors bg-white/10 hover:bg-white/20">
                    ${p.topic}
                </button>
            `).join('');
        }

        // é€‰æ‹©é¢„è®¾è¯é¢˜
        function selectPreset(index) {
            const preset = PRESET_TOPICS[index];
            document.getElementById('debate-topic').value = preset.topic;
            document.getElementById('pro-stance').value = preset.proStance;
            document.getElementById('con-stance').value = preset.conStance;
        }

        // æ¸²æŸ“é˜Ÿä¼é€‰æ‹©
        function renderTeamSelect() {
            const proContainer = document.getElementById('pro-team');
            const conContainer = document.getElementById('con-team');

            proContainer.innerHTML = PHILOSOPHERS.map(p => `
                <button onclick="toggleTeam('pro', '${p.type}')"
                    class="w-full flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${proTeam.includes(p.type) ? 'bg-emerald-500/30 border border-emerald-500' : 'bg-white/5 border border-white/10 hover:bg-white/10'}">
                    <span>${p.avatar}</span>
                    <span>${p.name}</span>
                </button>
            `).join('');

            conContainer.innerHTML = PHILOSOPHERS.map(p => `
                <button onclick="toggleTeam('con', '${p.type}')"
                    class="w-full flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${conTeam.includes(p.type) ? 'bg-rose-500/30 border border-rose-500' : 'bg-white/5 border border-white/10 hover:bg-white/10'}">
                    <span>${p.avatar}</span>
                    <span>${p.name}</span>
                </button>
            `).join('');
        }

        // åˆ‡æ¢é˜Ÿä¼æˆå‘˜
        function toggleTeam(team, member) {
            if (team === 'pro') {
                if (proTeam.includes(member)) {
                    if (proTeam.length > 1) proTeam = proTeam.filter(m => m !== member);
                } else {
                    proTeam.push(member);
                    conTeam = conTeam.filter(m => m !== member);
                }
            } else {
                if (conTeam.includes(member)) {
                    if (conTeam.length > 1) conTeam = conTeam.filter(m => m !== member);
                } else {
                    conTeam.push(member);
                    proTeam = proTeam.filter(m => m !== member);
                }
            }
            renderTeamSelect();
        }

        // å¼€å§‹è®¨è®º
        async function startDebate() {
            const topic = document.getElementById('debate-topic').value;
            const proStance = document.getElementById('pro-stance').value;
            const conStance = document.getElementById('con-stance').value;

            document.getElementById('start-debate-btn').disabled = true;
            document.getElementById('start-debate-btn').textContent = 'å¯åŠ¨ä¸­...';

            try {
                const response = await fetch('/api/debate/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic,
                        pro_stance: proStance,
                        con_stance: conStance,
                        pro_philosophers: proTeam,
                        con_philosophers: conTeam,
                        async: true,
                    }),
                });

                if (!response.ok) throw new Error('è¯·æ±‚å¤±è´¥');

                const data = await response.json();
                debateId = data.id;

                // æ˜¾ç¤ºç»“æœé¢æ¿
                document.getElementById('debate-config').classList.add('hidden');
                document.getElementById('debate-result').classList.remove('hidden');
                document.getElementById('debate-title').textContent = topic;

                // å¼€å§‹è½®è¯¢
                pollDebateStatus();
            } catch (error) {
                console.error('Debate error:', error);
                alert('å¯åŠ¨è®¨è®ºå¤±è´¥');
                document.getElementById('start-debate-btn').disabled = false;
                document.getElementById('start-debate-btn').textContent = 'å¼€å§‹è®¨è®º';
            }
        }

        // è½®è¯¢è®¨è®ºçŠ¶æ€
        async function pollDebateStatus() {
            try {
                const response = await fetch(`/api/debate/status?id=${debateId}`);
                if (!response.ok) throw new Error('æŸ¥è¯¢å¤±è´¥');

                const data = await response.json();
                updateDebateUI(data);

                if (data.status === 'running' || data.status === 'pending') {
                    pollTimer = setTimeout(pollDebateStatus, 2000);
                }
            } catch (error) {
                console.error('Poll error:', error);
            }
        }

        // æ›´æ–°è®¨è®º UI
        function updateDebateUI(data) {
            const statusEl = document.getElementById('debate-status');
            const phaseEl = document.getElementById('debate-phase');
            const recordsEl = document.getElementById('debate-records');

            // æ›´æ–°çŠ¶æ€
            const statusLabels = { pending: 'ç­‰å¾…ä¸­', running: 'è¿›è¡Œä¸­', completed: 'å·²å®Œæˆ', failed: 'å¤±è´¥' };
            const statusColors = { pending: 'bg-gray-500', running: 'bg-amber-500', completed: 'bg-emerald-500', failed: 'bg-red-500' };
            statusEl.textContent = statusLabels[data.status] || data.status;
            statusEl.className = `px-2 py-0.5 rounded text-xs ${statusColors[data.status] || 'bg-gray-500'}`;

            // æ›´æ–°é˜¶æ®µ
            const phaseLabels = { opening: 'å¼€åœºå‘è¨€', questioning: 'è´¨è¯¢äº¤é”‹', free_debate: 'è‡ªç”±è¾©è®º', closing: 'æ€»ç»“é™ˆè¯' };
            phaseEl.textContent = data.current_phase ? `å½“å‰é˜¶æ®µ: ${phaseLabels[data.current_phase] || data.current_phase}` : '';

            // æ›´æ–°è®°å½• (API è¿”å›å¤§å†™å­—æ®µåï¼Œéœ€è¦å…¼å®¹)
            if (data.records && data.records.length > 0) {
                const phaseColors = { opening: 'bg-emerald-500', questioning: 'bg-amber-500', free_debate: 'bg-blue-500', closing: 'bg-pink-500' };
                recordsEl.innerHTML = data.records.map(record => {
                    // å…¼å®¹å¤§å†™å’Œå°å†™å­—æ®µå
                    const phase = record.Phase || record.phase || '';
                    const speakerName = record.SpeakerName || record.speaker_name || '';
                    const content = record.Content || record.content || '';
                    return `
                    <div class="bg-white/5 rounded-xl p-4 message-enter">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="px-2 py-0.5 rounded text-xs ${phaseColors[phase] || 'bg-gray-500'}">${phaseLabels[phase] || phase}</span>
                            <span class="font-bold">${speakerName}</span>
                        </div>
                        <p class="text-white/80 whitespace-pre-wrap leading-relaxed">${content}</p>
                    </div>
                `}).join('');
                recordsEl.scrollTop = recordsEl.scrollHeight;
            }
        }

        // é‡ç½®è®¨è®º
        function resetDebate() {
            if (pollTimer) clearTimeout(pollTimer);
            debateId = null;
            document.getElementById('debate-config').classList.remove('hidden');
            document.getElementById('debate-result').classList.add('hidden');
            document.getElementById('debate-records').innerHTML = '';
            document.getElementById('start-debate-btn').disabled = false;
            document.getElementById('start-debate-btn').textContent = 'å¼€å§‹è®¨è®º';
        }

        // ==================== Agent æ¨¡å¼ ====================
        let agentChar = 'tomori';
        let agentSessionId = 'agent_' + Date.now();
        let agentParticipants = ['tomori', 'anon'];
        let agentMode = 'chat';

        // åˆ‡æ¢ Agent å­æ¨¡å¼
        function switchAgentMode(mode) {
            agentMode = mode;
            document.getElementById('agent-chat-view').classList.toggle('hidden', mode !== 'chat');
            document.getElementById('agent-discussion-view').classList.toggle('hidden', mode !== 'discussion');
            document.getElementById('btn-agent-chat').classList.toggle('bg-purple-500', mode === 'chat');
            document.getElementById('btn-agent-chat').classList.toggle('bg-white/10', mode !== 'chat');
            document.getElementById('btn-agent-discussion').classList.toggle('bg-purple-500', mode === 'discussion');
            document.getElementById('btn-agent-discussion').classList.toggle('bg-white/10', mode !== 'discussion');
        }

        // æ¸²æŸ“ Agent è§’è‰²é€‰æ‹©
        function renderAgentCharSelect() {
            const container = document.getElementById('agent-char-select');
            container.innerHTML = PHILOSOPHERS.map(p => `
                <button onclick="selectAgentChar('${p.type}')" 
                    class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${agentChar === p.type ? 'bg-purple-500' : 'bg-white/10 hover:bg-white/20'}">
                    <span>${p.avatar}</span>
                    <span>${p.name}</span>
                </button>
            `).join('');
        }

        // é€‰æ‹© Agent è§’è‰²
        function selectAgentChar(type) {
            agentChar = type;
            const char = PHILOSOPHERS.find(p => p.type === type);
            document.getElementById('agent-avatar').textContent = char.avatar;
            document.getElementById('agent-name').textContent = char.name;
            agentSessionId = 'agent_' + Date.now();
            document.getElementById('agent-messages').innerHTML = `
                <div id="agent-empty-state" class="h-full flex flex-col items-center justify-center text-center">
                    <span class="text-6xl mb-4">ğŸ¤–</span>
                    <h3 class="text-xl font-bold mb-2">Agent æ¨¡å¼ - ${char.name}</h3>
                    <p class="text-white/60 max-w-md">ä½“éªŒå¸¦æœ‰å·¥å…·è°ƒç”¨å’Œåæ€æœºåˆ¶çš„å¯¹è¯</p>
                </div>
            `;
            renderAgentCharSelect();
        }

        // å‘é€ Agent æ¶ˆæ¯
        async function sendAgentMessage() {
            const input = document.getElementById('agent-input');
            const content = input.value.trim();
            if (!content || isLoading) return;

            input.value = '';
            isLoading = true;
            document.getElementById('agent-send-btn').disabled = true;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addAgentMessage('user', content);
            showAgentTypingIndicator();

            try {
                const response = await fetch('/api/agent/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: agentSessionId,
                        message: content,
                        philosopher: agentChar,
                        enable_tools: document.getElementById('enable-tools').checked,
                        enable_reflection: document.getElementById('enable-reflection').checked,
                    }),
                });

                if (!response.ok) throw new Error('è¯·æ±‚å¤±è´¥');

                const data = await response.json();
                hideAgentTypingIndicator();
                addAgentMessage('assistant', data.response, data.philosopher, data.emotion_level, data.tool_results, data.reflection_result);
            } catch (error) {
                console.error('Agent chat error:', error);
                hideAgentTypingIndicator();
                addAgentMessage('assistant', 'æŠ±æ­‰ï¼ŒAgent æš‚æ—¶å‡ºäº†ç‚¹é—®é¢˜...');
            } finally {
                isLoading = false;
                document.getElementById('agent-send-btn').disabled = false;
            }
        }

        // æ·»åŠ  Agent æ¶ˆæ¯
        function addAgentMessage(role, content, philosopher = '', emotionLevel = '', toolResults = [], reflectionResult = null) {
            const container = document.getElementById('agent-messages');
            const emptyState = document.getElementById('agent-empty-state');
            if (emptyState) emptyState.remove();

            const char = PHILOSOPHERS.find(p => p.type === agentChar);
            const isUser = role === 'user';

            const msgDiv = document.createElement('div');
            msgDiv.className = `message-enter flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            // å·¥å…·è°ƒç”¨ä¿¡æ¯
            let toolInfo = '';
            if (toolResults && toolResults.length > 0) {
                toolInfo = `<div class="mt-2 p-2 bg-purple-500/20 rounded-lg text-xs">
                    <div class="font-bold text-purple-300 mb-1">ğŸ”§ å·¥å…·è°ƒç”¨:</div>
                    ${toolResults.map(t => `<div class="text-white/70">â€¢ ${t.tool_name}</div>`).join('')}
                </div>`;
            }

            // åæ€ä¿¡æ¯
            let reflectionInfo = '';
            if (reflectionResult) {
                const score = reflectionResult.confidence_score ? (reflectionResult.confidence_score * 100).toFixed(0) : '?';
                reflectionInfo = `<div class="mt-2 p-2 bg-indigo-500/20 rounded-lg text-xs">
                    <div class="font-bold text-indigo-300 mb-1">ğŸª åæ€ç»“æœ: ç½®ä¿¡åº¦ ${score}%</div>
                    ${reflectionResult.suggestions ? reflectionResult.suggestions.slice(0, 2).map(s => `<div class="text-white/70 truncate">â€¢ ${s}</div>`).join('') : ''}
                </div>`;
            }

            let emotionBadge = '';
            if (emotionLevel && emotionLevel !== 'neutral') {
                const emotionLabels = { pain: 'ğŸ˜¢ ç—›è‹¦', confused: 'ğŸ˜µ è¿·èŒ«', complaining: 'ğŸ˜¤ æŠ±æ€¨', excusing: 'ğŸ˜ æ‰¾å€Ÿå£' };
                emotionBadge = `<span class="text-xs px-2 py-0.5 rounded bg-white/10 text-white/60">${emotionLabels[emotionLevel] || emotionLevel}</span>`;
            }

            msgDiv.innerHTML = `
                <div class="max-w-[85%] ${isUser ? 'bg-purple-500/20 border-purple-500/30' : 'bg-white/10 border-white/20'} border rounded-2xl px-4 py-3">
                    ${!isUser ? `<div class="flex items-center gap-2 mb-2">
                        <span>${char.avatar}</span>
                        <span class="font-medium text-sm">${char.name}</span>
                        <span class="text-xs px-2 py-0.5 rounded bg-purple-500/30 text-purple-300">Agent</span>
                        ${emotionBadge}
                    </div>` : ''}
                    <p class="whitespace-pre-wrap leading-relaxed">${content}</p>
                    ${toolInfo}
                    ${reflectionInfo}
                </div>
            `;

            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showAgentTypingIndicator() {
            const container = document.getElementById('agent-messages');
            const indicator = document.createElement('div');
            indicator.id = 'agent-typing-indicator';
            indicator.className = 'flex items-center gap-2 text-white/60';
            indicator.innerHTML = `
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
                <span>Agent æ€è€ƒä¸­...</span>
            `;
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function hideAgentTypingIndicator() {
            const indicator = document.getElementById('agent-typing-indicator');
            if (indicator) indicator.remove();
        }

        // æ¸²æŸ“ä¸»æŒäººè®¨è®ºå‚ä¸è€…é€‰æ‹©
        function renderAgentParticipants() {
            const container = document.getElementById('agent-participants');
            container.innerHTML = PHILOSOPHERS.map(p => `
                <button onclick="toggleAgentParticipant('${p.type}')"
                    class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${agentParticipants.includes(p.type) ? 'bg-purple-500' : 'bg-white/10 hover:bg-white/20'}">
                    <span>${p.avatar}</span>
                    <span>${p.name}</span>
                </button>
            `).join('');
        }

        function toggleAgentParticipant(type) {
            if (agentParticipants.includes(type)) {
                if (agentParticipants.length > 2) {
                    agentParticipants = agentParticipants.filter(p => p !== type);
                }
            } else {
                agentParticipants.push(type);
            }
            renderAgentParticipants();
        }

        // å¼€å§‹ä¸»æŒäººè®¨è®º
        async function startAgentDiscussion() {
            const topic = document.getElementById('agent-discussion-topic').value;
            const maxRounds = parseInt(document.getElementById('agent-max-rounds').value) || 4;

            document.getElementById('start-agent-discussion-btn').disabled = true;
            document.getElementById('start-agent-discussion-btn').textContent = 'è®¨è®ºè¿›è¡Œä¸­...';

            try {
                const response = await fetch('/api/agent/discussion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic,
                        participants: agentParticipants,
                        max_rounds: maxRounds,
                    }),
                });

                if (!response.ok) throw new Error('è¯·æ±‚å¤±è´¥');

                const data = await response.json();
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('agent-discussion-config').classList.add('hidden');
                document.getElementById('agent-discussion-result').classList.remove('hidden');
                document.getElementById('agent-discussion-title').textContent = topic;

                // æ˜¾ç¤ºå†³ç­–
                if (data.decisions && data.decisions.length > 0) {
                    document.getElementById('agent-decisions-list').innerHTML = data.decisions.map(d => 
                        `<span class="inline-block px-2 py-0.5 rounded bg-purple-500/30 mr-1 mb-1">${d.action} â†’ ${d.next_speaker}</span>`
                    ).join('');
                }

                // æ˜¾ç¤ºè®°å½•
                const recordsEl = document.getElementById('agent-discussion-records');
                const phaseLabels = { opening: 'å¼€åœºå‘è¨€', questioning: 'è´¨è¯¢äº¤é”‹', free_debate: 'è‡ªç”±è¾©è®º', closing: 'æ€»ç»“é™ˆè¯' };
                const phaseColors = { opening: 'bg-emerald-500', questioning: 'bg-amber-500', free_debate: 'bg-blue-500', closing: 'bg-pink-500' };
                
                recordsEl.innerHTML = data.records.map(record => {
                    const phase = record.phase || '';
                    const speakerName = record.speaker_name || '';
                    const content = record.content || '';
                    return `
                        <div class="bg-white/5 rounded-xl p-4 message-enter">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-0.5 rounded text-xs ${phaseColors[phase] || 'bg-gray-500'}">${phaseLabels[phase] || phase}</span>
                                <span class="font-bold">${speakerName}</span>
                            </div>
                            <p class="text-white/80 whitespace-pre-wrap leading-relaxed">${content}</p>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Agent discussion error:', error);
                alert('ä¸»æŒäººè®¨è®ºå¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('start-agent-discussion-btn').disabled = false;
                document.getElementById('start-agent-discussion-btn').textContent = 'å¼€å§‹ä¸»æŒäººè®¨è®º';
            }
        }

        function resetAgentDiscussion() {
            document.getElementById('agent-discussion-config').classList.remove('hidden');
            document.getElementById('agent-discussion-result').classList.add('hidden');
            document.getElementById('agent-discussion-records').innerHTML = '';
            document.getElementById('agent-decisions-list').innerHTML = '';
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
